<div>
    <h2 class="text-2xl font-bold mb-10 text-blue-600">ðŸ’Š AI Medicine Chat</h2>
    <!-- Classification Form -->
    

 <div id="chat-box" class="mt-6 mb-6 space-y-4 h-96 overflow-y-auto flex flex-col-reverse p-4 rounded bg-gray-300">
    {% for msg in ai_messages %}
        {% if msg.sender == "user" %}
            <div class="flex justify-end">
                <div class="bg-blue-100 mb-5 px-4 py-2 rounded-2xl max-w-xl">
                    <strong>You:</strong> {{ msg.content }}
                </div>
            </div>
        {% else %}
            {% if forloop.first and show_typing %}
                <div id="typing-message" class="max-w-xl bg-gray-100 text-gray-900 p-3 rounded-2xl rounded-bl-sm">
                    <span id="typing-dots" class="flex gap-1">
                        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-150"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-300"></span>
                    </span>
                </div>
            {% else %}
                <div class="max-w-xl bg-gray-100 text-gray-900 p-3 rounded-2xl rounded-bl-sm">
                    <strong>AI answer:</strong> {{ msg.content|linebreaks|safe }}
                </div>
            {% endif %}
        {% endif %}
    {% endfor %}
</div>



 
   
</div>
<form action="" class="space-y-4" method="post" class="mt-6">
        {% csrf_token %}
        <!-- <input type="text" name="q" 
            class='w-full py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm resize-none'
            rows="3" cols="40"
            placeholder='e.g. paracetamol tablet 500mg',
        >
        </input> -->
        <div class="space-y-4">
            {% for field in form %}
            <div>
                <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ field.label }}
                </label>
                {{ field }}
                {% if field.errors %}
                <p class="text-sm text-red-600 mt-1">{{ field.errors|join:", " }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <button 
            type="submit" hx-indicator="#indicator"
            id="submit-btn"
            class="cursor-pointer flex px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
            <span class="hide-button">âš¡ Submit</span>
            <span class="htmx-indicator">
                <span class="flex space-x-1 items-baseline">
                    <span class="mr-2">âš¡ AI is thinking</span>
                    <span class="w-1 h-1 bg-white rounded-full animate-bounce delay-[0ms]"></span>
                    <span class="w-1 h-1 bg-white rounded-full animate-bounce delay-[150ms]"></span>
                    <span class="w-1 h-1 bg-white rounded-full animate-bounce delay-[300ms]"></span>
                </span>
            </span>
        </button>
    </form>


    {% if show_typing %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const typingMessage = document.getElementById("typing-message");
    const chatBox = document.getElementById("chat-box");
    const submitBtn = document.getElementById("submit-btn");
    if (!typingMessage || !chatBox) return;
    // Disable submit while typing
    submitBtn.disabled = true;
    submitBtn.classList.add("opacity-50", "cursor-not-allowed");
    // Use plain text for typing animation to avoid breaking HTML
    const finalText = `{{ ai_response|striptags|escapejs }}`;
    let i = 0;
    typingMessage.textContent = ""; // reset

    const interval = setInterval(() => {
        typingMessage.textContent += finalText[i];
        i++;
        chatBox.scrollTop = chatBox.scrollHeight; // auto-scroll
        if (i >= finalText.length) {
            clearInterval(interval);
            // Replace with full markdown-rendered HTML after typing
            typingMessage.innerHTML = `{{ ai_response|safe }}`;
             // Enable submit button again
            submitBtn.disabled = false;
            submitBtn.classList.remove("opacity-50", "cursor-not-allowed");
        }
    }, 20);
});
</script>
{% endif %}